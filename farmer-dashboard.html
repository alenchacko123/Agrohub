<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AgroHub - Farmer Dashboard</title>
    <meta name="description"
        content="Your AgroHub farmer dashboard. Rent equipment, hire workers, access tutorials, and manage your farming operations.">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">

    <link rel="stylesheet" href="css/farmer-dashboard.css">
</head>

<body>
    <!-- Floating Background Elements -->
    <div class="floating-elements">
        <span class="floating-leaf material-icons-outlined">eco</span>
        <span class="floating-leaf material-icons-outlined">grass</span>
        <span class="floating-leaf material-icons-outlined">nature</span>
    </div>

    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="landingpage.html" class="sidebar-logo">
                    <span class="material-icons-outlined">spa</span>
                    AgroHub
                </a>
            </div>

            <div class="sidebar-user">
                <div class="user-avatar" id="user-avatar">U</div>
                <div class="user-info">
                    <h4 id="user-name">User</h4>
                    <span><span class="status-dot"></span> Active Farmer</span>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <span class="nav-section-title">Main Menu</span>
                </div>
                <a href="javascript:void(0)" class="nav-item active" onclick="switchView('overview', this)">
                    <span class="material-icons-outlined">dashboard</span>
                    Overview
                </a>

                <div class="nav-section">
                    <span class="nav-section-title">Essential Services</span>
                </div>
                <a href="javascript:void(0)" class="nav-item" onclick="switchView('machinery', this)">
                    <span class="material-icons-outlined">agriculture</span>
                    Get Machinery
                </a>
                <a href="javascript:void(0)" class="nav-item" onclick="switchView('workers', this)">
                    <span class="material-icons-outlined">groups</span>
                    Hire Workers
                </a>
                <a href="javascript:void(0)" class="nav-item" onclick="switchView('skills', this)">
                    <span class="material-icons-outlined">school</span>
                    Skill Center
                </a>

                <div class="nav-section">
                    <span class="nav-section-title">Support</span>
                </div>
                <a href="javascript:void(0)" class="nav-item" onclick="switchView('contracts', this)">
                    <span class="material-icons-outlined">description</span>
                    My Contracts
                    <span class="badge">3</span>
                </a>
                <a href="javascript:void(0)" class="nav-item" onclick="switchView('profile', this)">
                    <span class="material-icons-outlined">person</span>
                    My Profile
                </a>
            </nav>

            <div class="sidebar-footer">
                <button class="logout-btn" onclick="logout()">
                    <span class="material-icons-outlined">logout</span>
                    Sign Out
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <div class="topbar">
                <div class="topbar-left">
                    <h1 id="welcome-message">Welcome back! 👋</h1>
                    <div class="breadcrumb">
                        <span class="material-icons-outlined" style="font-size: 1rem;">home</span>
                        Dashboard / Overview
                    </div>
                </div>
                <div class="topbar-right">
                    <div class="search-box">
                        <span class="material-icons-outlined">search</span>
                        <input type="text" placeholder="Search equipment, workers...">
                    </div>
                    <button id="farmerNotificationsBtn" class="icon-btn tooltip" data-tooltip="Notifications"
                        onclick="toggleFarmerNotifications()">
                        <span class="material-icons-outlined">notifications</span>
                        <span class="notification-badge" id="farmerNotificationCount" style="display: none;">0</span>
                    </button>
                    <button class="icon-btn tooltip" data-tooltip="Messages">
                        <span class="material-icons-outlined">chat</span>
                    </button>
                </div>
            </div>

            <!-- Compact Overview Header -->
            <div class="dashboard-overview-bar"
                style="display: flex; gap: 1rem; margin-bottom: 2rem; overflow-x: auto; padding-bottom: 0.5rem;">
                <div class="overview-chip"
                    style="background: var(--surface-white); padding: 0.75rem 1.25rem; border-radius: 50px; display: flex; align-items: center; gap: 0.75rem; box-shadow: var(--shadow-sm); border: 1px solid rgba(0,0,0,0.05); white-space: nowrap;">
                    <div
                        style="width: 32px; height: 32px; background: #eff6ff; color: #3b82f6; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <span class="material-icons-outlined" style="font-size: 1.2rem;">agriculture</span>
                    </div>
                    <div><span style="font-weight: 700; font-size: 1.1rem;">5</span> <span
                            style="font-size: 0.8rem; color: var(--text-secondary); margin-left: 2px;">Rentals</span>
                    </div>
                </div>
                <div class="overview-chip"
                    style="background: var(--surface-white); padding: 0.75rem 1.25rem; border-radius: 50px; display: flex; align-items: center; gap: 0.75rem; box-shadow: var(--shadow-sm); border: 1px solid rgba(0,0,0,0.05); white-space: nowrap;">
                    <div
                        style="width: 32px; height: 32px; background: #fffbeb; color: #f59e0b; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <span class="material-icons-outlined" style="font-size: 1.2rem;">groups</span>
                    </div>
                    <div><span style="font-weight: 700; font-size: 1.1rem;">12</span> <span
                            style="font-size: 0.8rem; color: var(--text-secondary); margin-left: 2px;">Workers</span>
                    </div>
                </div>
                <div class="overview-chip"
                    style="background: var(--surface-white); padding: 0.75rem 1.25rem; border-radius: 50px; display: flex; align-items: center; gap: 0.75rem; box-shadow: var(--shadow-sm); border: 1px solid rgba(0,0,0,0.05); white-space: nowrap;">
                    <div
                        style="width: 32px; height: 32px; background: #f5f3ff; color: #8b5cf6; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <span class="material-icons-outlined" style="font-size: 1.2rem;">history_edu</span>
                    </div>
                    <div><span style="font-weight: 700; font-size: 1.1rem;">3</span> <span
                            style="font-size: 0.8rem; color: var(--text-secondary); margin-left: 2px;">Pending</span>
                    </div>
                </div>
                <div class="overview-chip"
                    style="background: var(--surface-white); padding: 0.75rem 1.25rem; border-radius: 50px; display: flex; align-items: center; gap: 0.75rem; box-shadow: var(--shadow-sm); border: 1px solid rgba(0,0,0,0.05); white-space: nowrap;">
                    <div
                        style="width: 32px; height: 32px; background: #ecfdf5; color: #10b981; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <span class="material-icons-outlined" style="font-size: 1.2rem;">school</span>
                    </div>
                    <div><span style="font-weight: 700; font-size: 1.1rem;">8</span> <span
                            style="font-size: 0.8rem; color: var(--text-secondary); margin-left: 2px;">Learnt</span>
                    </div>
                </div>
                <!-- Mini Weather Chip -->
                <div class="overview-chip weather-chip"
                    style="background: linear-gradient(135deg, #38bdf8, #0ea5e9); color: white; padding: 0.75rem 1.25rem; border-radius: 50px; display: flex; align-items: center; gap: 0.75rem; box-shadow: 0 4px 10px rgba(14, 165, 233, 0.2); white-space: nowrap; margin-left: auto;">
                    <span style="font-size: 1.2rem;">⛅</span>
                    <span style="font-weight: 600;">28°C</span>
                    <span style="font-size: 0.8rem; opacity: 0.9;">Partly Cloudy</span>
                </div>
            </div>

            <!-- View: Overview -->
            <div id="view-overview" class="dashboard-view active">
                <div class="dashboard-grid">
                    <!-- Simplified Hub Section -->
                    <div class="card">
                        <div class="card-header">
                            <h2>🚀 Quick Access</h2>
                        </div>
                        <div class="services-grid" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));">
                            <!-- Group 1: Machinery Hub -->
                            <div class="service-hub">
                                <div class="service-hub-image-container">
                                    <img src="images/machinery-center-updated.png" class="service-hub-image">
                                </div>
                                <div style="padding: 1.25rem;">
                                    <h3 style="font-size: 1.1rem; font-weight: 700; margin-bottom: 0.5rem;">Machinery
                                        Center</h3>
                                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 1rem;">
                                        Rent or buy tractors, tillers, and harvesters easier.</p>
                                    <div style="display: flex; gap: 0.75rem;">
                                        <button class="quick-action-btn primary"
                                            onclick="window.location.href='rent-equipment.html'"
                                            style="flex: 1; font-size: 0.8rem; padding: 0.6rem;">Rent Now</button>
                                        <button class="quick-action-btn secondary"
                                            onclick="window.location.href='buy-equipment.html'"
                                            style="flex: 1; font-size: 0.8rem; padding: 0.6rem;">Buy Used</button>
                                    </div>
                                </div>
                            </div>
                            <!-- Farm Labor Hub -->
                            <div class="service-hub">
                                <div class="service-hub-image-container">
                                    <img src="images/farm-labor-hub.png" class="service-hub-image"
                                        alt="Farm workers team">
                                </div>
                                <div style="padding: 1.5rem;">
                                    <h3
                                        style="font-size: 1.3rem; font-weight: 700; margin-bottom: 0.75rem; color: var(--text-main);">
                                        Farm Labor Hub
                                    </h3>
                                    <p
                                        style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1.5rem; line-height: 1.6;">
                                        Hire skilled workers and machine operators today.
                                    </p>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                                        <button class="quick-action-btn primary"
                                            onclick="window.location.href='post-job.html'"
                                            style="width: 100%; padding: 0.75rem; font-size: 0.9rem; border-radius: 12px;">
                                            Create Job
                                        </button>
                                        <button class="quick-action-btn secondary"
                                            onclick="window.location.href='my-posted-jobs.html'"
                                            style="width: 100%; padding: 0.75rem; font-size: 0.9rem; border-radius: 12px;">
                                            View Posted Jobs
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <!-- Group 3: Learn & Protect -->
                            <div class="service-hub">
                                <div class="service-hub-image-container">
                                    <img src="images/dashboard-learn-updated.png" class="service-hub-image">
                                </div>
                                <div style="padding: 1.25rem;">
                                    <h3 style="font-size: 1.1rem; font-weight: 700; margin-bottom: 0.5rem;">Learn &
                                        Protect</h3>
                                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 1rem;">
                                        Video tutorials and easy rental agreements.</p>
                                    <div style="display: flex; gap: 0.75rem;">
                                        <button class="quick-action-btn primary"
                                            onclick="window.location.href='tutorials.html'"
                                            style="flex: 1; font-size: 0.8rem; padding: 0.6rem;">Watch Tips</button>
                                        <button class="quick-action-btn secondary"
                                            onclick="window.location.href='agreements.html'"
                                            style="flex: 1; font-size: 0.8rem; padding: 0.6rem;">Agreements</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Status -->
                    <div class="card" style="padding: 1.5rem;">
                        <h2 style="font-size: 1.2rem; margin-bottom: 1rem;">📋 Status</h2>
                        <div class="activity-feed">
                            <div class="feed-item"
                                style="border-left: 2px solid #3b82f6; padding-left: 1rem; margin-bottom: 1rem;">
                                <div style="font-size: 0.85rem; font-weight: 600;">Active Rental</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">Tractor - 3 days left
                                </div>
                            </div>
                            <div class="feed-item" style="border-left: 2px solid #10b981; padding-left: 1rem;">
                                <div style="font-size: 0.85rem; font-weight: 600;">Hired Workers</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">2 helpers arriving
                                    tomorrow</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- View: Machinery -->
            <div id="view-machinery" class="dashboard-view">
                <div class="card" style="margin-bottom: 2rem;">
                    <div class="card-header">
                        <h2>🚜 Machinery Center</h2>
                    </div>
                    <div class="services-grid"
                        style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem;">
                        <div class="service-hub">
                            <div class="service-hub-image-container">
                                <img src="images/rent-equipment.png" class="service-hub-image">
                            </div>
                            <div style="padding: 1.25rem;">
                                <h3 style="font-size: 1.1rem; margin-bottom: 0.5rem;">Rent Equipment</h3>
                                <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 1rem;">Daily
                                    rentals for all farm needs.</p>
                                <button class="quick-action-btn primary"
                                    onclick="window.location.href='rent-equipment.html'"
                                    style="width: 100%; border-radius: 8px;">View Rentals</button>
                            </div>
                        </div>
                        <div class="service-hub">
                            <div class="service-hub-image-container">
                                <img src="images/buy-used-equipment.png" class="service-hub-image">
                            </div>
                            <div style="padding: 1.25rem;">
                                <h3 style="font-size: 1.1rem; margin-bottom: 0.5rem;">Buy Used Equipment</h3>
                                <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 1rem;">
                                    Quality verified second-hand units.</p>
                                <button class="quick-action-btn secondary"
                                    onclick="window.location.href='buy-equipment.html'"
                                    style="width: 100%; border-radius: 8px;">Browse Shop</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- View: Workers -->
            <div id="view-workers" class="dashboard-view">
                <div class="card">
                    <div class="card-header">
                        <h2>👥 Farm Labor Center</h2>
                    </div>
                    <div class="services-grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
                        <!-- Post Job Card - NEW -->
                        <div class="service-hub">
                            <div class="service-hub-image-container"
                                style="height: 280px; overflow: hidden; position: relative; background: linear-gradient(135deg, #16a34a, #15803d); display: flex; align-items: center; justify-content: center;">
                                <span class="material-icons-outlined"
                                    style="font-size: 120px; color: rgba(255,255,255,0.3);">work</span>
                            </div>
                            <div style="padding: 1.5rem;">
                                <h3>📋 Post Job</h3>
                                <p>Post job requirements and hire workers for your farm</p>
                                <button class="quick-action-btn primary" onclick="window.location.href='post-job.html'"
                                    style="width: 100%; margin-top: 1rem;">Post a Job</button>
                            </div>
                        </div>
                        <!-- My Posted Jobs Card -->
                        <div class="service-hub">
                            <div class="service-hub-image-container"
                                style="height: 280px; overflow: hidden; position: relative; background: linear-gradient(135deg, #10b981, #059669); display: flex; align-items: center; justify-content: center;">
                                <span class="material-icons-outlined"
                                    style="font-size: 120px; color: rgba(255,255,255,0.3);">assignment_ind</span>
                            </div>
                            <div style="padding: 1.5rem;">
                                <h3>My Posted Jobs</h3>
                                <p>Track your job listings and view worker applications.</p>
                                <button class="quick-action-btn secondary"
                                    onclick="window.location.href='my-posted-jobs.html'"
                                    style="width: 100%; margin-top: 1rem; border: 2px solid var(--primary-green); color: var(--primary-green); background: white;">View
                                    My Jobs</button>
                            </div>
                        </div>
                        <!-- Machine Operators Card -->
                        <div class="service-hub">
                            <div class="service-hub-image-container">
                                <img src="images/machine-operators.png" class="service-hub-image">
                            </div>
                            <div style="padding: 1.5rem;">
                                <h3>Machine Operators</h3>
                                <p>Expert drivers for your heavy machinery.</p>
                                <button class="quick-action-btn secondary"
                                    onclick="window.location.href='job-portal-dashboard.html'"
                                    style="width: 100%; margin-top: 1rem;">View Portal</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- View: Skills -->
            <div id="view-skills" class="dashboard-view">
                <div class="card">
                    <div class="card-header">
                        <h2>📚 Skill Learning Center</h2>
                    </div>
                    <div class="services-grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
                        <div class="service-hub">
                            <div class="service-hub-image-container">
                                <img src="images/tutorial-library.png" class="service-hub-image">
                            </div>
                            <div style="padding: 1.5rem;">
                                <h3>Tutorial Library</h3>
                                <p>Learn how to use modern farming tech.</p>
                                <button class="quick-action-btn primary" onclick="window.location.href='tutorials.html'"
                                    style="width: 100%; margin-top: 1rem;">Watch Videos</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- View: Contracts -->
            <div id="view-contracts" class="dashboard-view">
                <div class="card">
                    <div class="card-header">
                        <h2>📄 My Contracts & Policies</h2>
                    </div>
                    <div class="services-grid"
                        style="display: flex; justify-content: center; flex-wrap: wrap; gap: 1.5rem;">
                        <div class="service-hub">
                            <div class="service-hub-image-container">
                                <img src="images/download (1).jpg" class="service-hub-image">
                            </div>
                            <div style="padding: 1.5rem;">
                                <h3>Rental Agreements</h3>
                                <p>View and sign your digital contracts.</p>
                                <button class="quick-action-btn primary"
                                    onclick="window.location.href='agreements.html'"
                                    style="width: 100%; margin-top: 1rem;">Open My Documents</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- View: Profile -->
            <div id="view-profile" class="dashboard-view">
                <div class="profile-card-premium">
                    <h2 style="font-family: var(--font-serif); font-size: 2rem; margin-bottom: 2rem; text-align: left;">
                        Profile Settings</h2>

                    <div class="profile-avatar-section">
                        <div class="avatar-edit-wrapper">
                            <img src="https://images.unsplash.com/photo-1534528741775-53994a69daeb?q=80&w=400"
                                id="profile-display-img">
                            <label for="avatar-input" class="avatar-upload-icon">
                                <span class="material-icons-outlined">photo_camera</span>
                            </label>
                            <input type="file" id="avatar-input" hidden accept="image/*"
                                onchange="previewAvatar(event)">
                        </div>
                    </div>

                    <form class="profile-premium-form" id="profileForm">
                        <div class="form-premium-row">
                            <div class="form-group">
                                <label>Full Name</label>
                                <input type="text" id="profile-name-input" value="" placeholder="Your Name">
                            </div>
                            <div class="form-group">
                                <label>Email Address</label>
                                <input type="email" id="profile-email-input" value="" placeholder="Your Email">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Change Password (leave blank to keep current)</label>
                            <div class="pass-input-container">
                                <input type="password" id="profile-pass-input" value="" placeholder="••••••••">
                                <span class="material-icons-outlined toggle-pass"
                                    onclick="toggleProfilePassword(this)">visibility</span>
                            </div>
                        </div>

                        <button type="button" class="btn-update-profile" onclick="handleProfileUpdate()">
                            <span class="material-icons-outlined">save</span>
                            UPDATE PROFILE DETAILS
                        </button>

                        <p class="premium-form-footer">Changes will be saved permanently to your account.</p>
                    </form>
                </div>
            </div>

            <script>
                function toggleProfilePassword(icon) {
                    const input = document.getElementById('profile-pass-input');
                    if (!input) return;

                    if (!icon) icon = document.querySelector('.toggle-pass');

                    if (input.type === 'password') {
                        input.type = 'text';
                        icon.textContent = 'visibility_off';
                    } else {
                        input.type = 'password';
                        icon.textContent = 'visibility';
                    }
                }

                function previewAvatar(event) {
                    const reader = new FileReader();
                    reader.onload = function () {
                        const output = document.getElementById('profile-display-img');
                        output.src = reader.result;
                        // Also update sidebar avatar if possible
                        document.getElementById('user-avatar').innerHTML = `<img src="${reader.result}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">`;
                    }
                    reader.readAsDataURL(event.target.files[0]);
                }

                async function handleProfileUpdate() {
                    const btn = document.querySelector('.btn-update-profile');
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<span class="material-icons-outlined">sync</span> UPDATING...';
                    btn.disabled = true;

                    const newName = document.getElementById('profile-name-input').value;
                    const newEmail = document.getElementById('profile-email-input').value;
                    const newPassword = document.getElementById('profile-pass-input').value;
                    const profileImg = document.getElementById('profile-display-img').src;

                    const token = localStorage.getItem('agrohub_token');

                    try {
                        const payload = {
                            name: newName,
                            email: newEmail,
                            password: newPassword,
                            picture: profileImg.startsWith('data:image') ? profileImg : null
                        };

                        const response = await fetch('php/update_profile.php', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': 'Bearer ' + token
                            },
                            body: JSON.stringify(payload)
                        });

                        const result = await response.json();

                        if (result.success) {
                            // Update local storage for immediate persistence on refresh
                            const userDataStr = localStorage.getItem('agrohub_user');
                            if (userDataStr) {
                                try {
                                    const userData = JSON.parse(userDataStr);
                                    userData.name = newName;
                                    userData.email = newEmail;
                                    if (payload.picture) {
                                        userData.picture = payload.picture;
                                    }
                                    localStorage.setItem('agrohub_user', JSON.stringify(userData));

                                    // Update sidebar and other UI elements
                                    updateUserUI(userData);
                                } catch (e) {
                                    console.error('Error updating local storage:', e);
                                }
                            }

                            btn.innerHTML = '<span class="material-icons-outlined">done</span> UPDATED SUCCESSFULLY';
                            btn.style.background = '#10b981';
                            btn.style.color = '#fff';

                            // Clear password field
                            document.getElementById('profile-pass-input').value = '';
                        } else {
                            btn.innerHTML = '<span class="material-icons-outlined">error</span> ' + (result.message || 'Update failed');
                            btn.style.background = '#ef4444';
                            btn.style.color = '#fff';
                        }
                    } catch (error) {
                        console.error('Update error:', error);
                        btn.innerHTML = '<span class="material-icons-outlined">error</span> CONNECTION FAILED';
                        btn.style.background = '#ef4444';
                        btn.style.color = '#fff';
                    }

                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.style.background = '';
                        btn.style.color = '';
                        btn.disabled = false;
                    }, 3000);
                }
            </script>
        </main>
    </div>

    <!-- Mobile Toggle Button -->
    <button class="mobile-toggle" id="mobileToggle">
        <span class="material-icons-outlined">menu</span>
    </button>

    <script>
        // Mobile Sidebar Toggle
        const sidebar = document.getElementById('sidebar');
        const mobileToggle = document.getElementById('mobileToggle');

        mobileToggle.addEventListener('click', () => {
            sidebar.classList.toggle('active');
            const icon = mobileToggle.querySelector('.material-icons-outlined');
            icon.textContent = sidebar.classList.contains('active') ? 'close' : 'menu';
        });

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', (e) => {
            if (window.innerWidth <= 992) {
                if (!sidebar.contains(e.target) && !mobileToggle.contains(e.target)) {
                    sidebar.classList.remove('active');
                    mobileToggle.querySelector('.material-icons-outlined').textContent = 'menu';
                }
            }
        });

        // Logout function
        // Global variables
        let currentUser = null;
        let dashboardData = null;

        /**
         * Switches the dashboard view based on sidebar selection
         */
        function switchView(viewId, element) {
            // Hide all views
            document.querySelectorAll('.dashboard-view').forEach(view => {
                view.classList.remove('active');
            });

            // Show selected view
            const targetView = document.getElementById('view-' + viewId);
            if (targetView) {
                targetView.classList.add('active');
            }

            // Update sidebar active state
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            if (element) {
                element.classList.add('active');
            } else {
                // If called from a hub card, find the sidebar item to highlight
                const sidebarItem = document.querySelector(`.nav-item[onclick*="'${viewId}'"]`);
                if (sidebarItem) sidebarItem.classList.add('active');
            }

            // Update breadcrumb
            const breadcrumb = document.querySelector('.breadcrumb');
            if (breadcrumb) {
                let viewName = viewId.charAt(0).toUpperCase() + viewId.slice(1);
                if (viewId === 'overview') viewName = 'Overview';
                if (viewId === 'machinery') viewName = 'Machinery';
                if (viewId === 'workers') viewName = 'Hire Workers';
                if (viewId === 'skills') viewName = 'Skills';
                if (viewId === 'contracts') viewName = 'My Documents';

                breadcrumb.innerHTML = `<span class="material-icons-outlined" style="font-size: 1rem;">home</span> Dashboard / ${viewName}`;
            }
        }

        /**
         * Load user info and dashboard data from PHP Backend
         */
        async function loadDashboardData() {
            const token = localStorage.getItem('agrohub_token');
            const userDataStr = localStorage.getItem('agrohub_user');

            // Allow dashboard to work without authentication for testing
            if (!token || !userDataStr) {
                console.log('No authentication found, using default user');
                // Don't redirect, just use default values
                updateUserUI({ name: 'Guest Farmer', email: 'guest@agrohub.com' });
                // Keep the static HTML service cards working
                return;
            }

            try {
                // Pass token in URL as backup in case headers are stripped
                const response = await fetch(`php/get_dashboard_data.php?token=${token}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    currentUser = result.data.user;
                    dashboardData = result.data.services;

                    updateUserUI(currentUser);
                    // Only render services if we have data from backend
                    if (dashboardData && dashboardData.length > 0) {
                        renderServices(dashboardData);
                    }
                } else {
                    // Session might be expired
                    console.error('Session error:', result.message);
                    localStorage.removeItem('agrohub_token');
                    localStorage.removeItem('agrohub_user');
                    // Keep static cards working, don't redirect
                }
            } catch (error) {
                console.error('Fetch error:', error);
                // Fallback to local data if server is down (for development)
                if (userDataStr) {
                    try {
                        const userData = JSON.parse(userDataStr);
                        updateUserUI(userData);
                    } catch (e) {
                        console.error('Error parsing user data:', e);
                    }
                }
                // Keep the static HTML service cards working
                console.log('Running in offline mode - using static service cards');
            }
        }

        /**
         * Update User-related UI elements
         */
        function updateUserUI(user) {
            const userName = user.name || user.email || 'User';
            const firstName = userName.split(' ')[0].split('@')[0];

            // Generate initials
            let initials = '';
            if (user.name) {
                const parts = user.name.split(' ');
                initials = parts[0].charAt(0).toUpperCase() + (parts.length > 1 ? parts[parts.length - 1].charAt(0).toUpperCase() : '');
            } else {
                initials = userName.substring(0, 2).toUpperCase();
            }

            // Update DOM
            const avatarEl = document.getElementById('user-avatar');
            const nameEl = document.getElementById('user-name');
            const welcomeEl = document.getElementById('welcome-message');

            if (avatarEl) {
                if (user.picture) {
                    avatarEl.style.backgroundImage = `url(${user.picture})`;
                    avatarEl.style.backgroundSize = 'cover';
                    avatarEl.innerHTML = ''; // Clear initials and any existing img tags
                } else {
                    avatarEl.textContent = initials;
                    avatarEl.style.backgroundImage = 'none';
                }
            }

            if (nameEl) nameEl.textContent = userName;
            if (welcomeEl) welcomeEl.textContent = `Welcome back, ${firstName}! 👋`;

            // Update Profile View Inputs
            const profileNameInput = document.getElementById('profile-name-input');
            const profileEmailInput = document.getElementById('profile-email-input');
            const profileDisplayImg = document.getElementById('profile-display-img');

            if (profileNameInput) profileNameInput.value = user.name || '';
            if (profileEmailInput) profileEmailInput.value = user.email || '';

            if (profileDisplayImg) {
                if (user.picture) {
                    profileDisplayImg.src = user.picture;
                }
            }
        }

        /**
         * Dynamically render service cards from database
         */
        function renderServices(services) {
            const servicesGrid = document.querySelector('.services-grid');
            if (!servicesGrid || !services || !Array.isArray(services) || services.length === 0) {
                console.log('No valid services data, keeping static HTML service cards');
                return;
            }

            // Define the three main hubs
            const hubs = [
                {
                    title: 'Machinery Center',
                    desc: 'Rent or buy tractors, tillers, and harvesters easier.',
                    img: 'images/machinery-center-updated.png',
                    actions: [
                        { label: 'Rent Now', link: 'rent-equipment.html', type: 'primary' },
                        { label: 'Buy Used', link: 'buy-equipment.html', type: 'secondary' }
                    ]
                },
                {
                    title: 'Farm Labor Hub',
                    desc: 'Hire skilled workers and machine operators today.',
                    img: 'images/dashboard-labor.png',
                    actions: [
                        { label: 'Find Labor', link: 'hire-workers.html', type: 'primary' },
                        { label: 'Operators', link: 'hire-workers.html', type: 'secondary' }
                    ]
                },
                {
                    title: 'Learn & Protect',
                    desc: 'Video tutorials and easy rental agreements.',
                    img: 'images/dashboard-learn-updated.png',
                    actions: [
                        { label: 'Watch Tips', link: 'tutorials.html', type: 'primary' },
                        { label: 'Agreements', link: 'agreements.html', type: 'secondary' }
                    ]
                }
            ];

            servicesGrid.innerHTML = hubs.map(hub => `
                <div class="service-hub">
                    <div class="service-hub-image-container" style="height: 280px; overflow: hidden; position: relative; border-radius: 20px 20px 0 0;">
                        <img src="${hub.img}" class="service-hub-image" style="width: 100%; height: 100%; object-fit: cover;">
                    </div>
                    <div style="padding: 1.5rem;">
                        <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 0.5rem;">${hub.title}</h3>
                        <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1.25rem;">${hub.desc}</p>
                        <div style="display: flex; gap: 0.75rem;">
                            ${hub.actions.map(action => `
                                <button class="quick-action-btn ${action.type}" onclick="window.location.href='${action.link}'" style="flex: 1; font-size: 0.8rem; padding: 0.6rem;">${action.label}</button>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Run on page load
        window.addEventListener('DOMContentLoaded', loadDashboardData);

        function logout() {
            if (confirm('Are you sure you want to sign out?')) {
                // Clear user data from localStorage
                localStorage.removeItem('agrohub_user');
                // Redirect to login page
                window.location.href = 'login-farmer.html';
            }
        }

        // Active nav item handler - Disabled to prevent interference with navigation
        // The active class should be managed server-side or on page load
        /*
        const navItems = document.querySelectorAll('.nav-item');
        navItems.forEach(item => {
            item.addEventListener('click', function (e) {
                // Remove active class from all
                navItems.forEach(nav => nav.classList.remove('active'));
                // Add to clicked
                this.classList.add('active');
            });
        });
        */

        // Search functionality (placeholder)
        const searchInput = document.querySelector('.search-box input');
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const query = e.target.value.trim();
                if (query) {
                    console.log('Searching for:', query);
                    // Add your search logic here
                }
            }
        });

        // Stats counter animation
        function animateCounters() {
            const counters = document.querySelectorAll('.stat-value');
            counters.forEach(counter => {
                const target = parseInt(counter.textContent);
                let current = 0;
                const increment = target / 30;
                const timer = setInterval(() => {
                    current += increment;
                    if (current >= target) {
                        counter.textContent = target;
                        clearInterval(timer);
                    } else {
                        counter.textContent = Math.floor(current);
                    }
                }, 50);
            });
        }

        // Run counter animation on page load
        window.addEventListener('load', animateCounters);

        // Quick action button handlers
        const quickActionButtons = document.querySelectorAll('.quick-action-btn');
        quickActionButtons.forEach(btn => {
            btn.addEventListener('click', function () {
                const buttonText = this.textContent.trim();
                if (buttonText.includes('New Rental')) {
                    window.location.href = 'rent-equipment.html';
                } else if (buttonText.includes('Find Worker')) {
                    window.location.href = 'hire-workers.html';
                }
            });
        });
    </script>

    <!-- Farmer Notifications Panel -->
    <div id="farmerNotificationsPanel">
        <div class="farmer-notification-header">
            <h3>
                <span class="material-icons-outlined">notifications_active</span>
                My Rental Requests
            </h3>
            <button class="farmer-close-panel" onclick="toggleFarmerNotifications()">
                <span class="material-icons-outlined">close</span>
            </button>
        </div>
        <div class="farmer-notification-list" id="farmerNotificationList">
            <!-- Notifications will be loaded here -->
        </div>
    </div>

    <!-- Toast Notification for Rental Status Updates -->
    <div id="rentalToastContainer"
        style="position: fixed; top: 100px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 1rem; max-width: 400px;">
    </div>

    <style>
        .rental-toast {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            border-left: 5px solid;
            animation: slideInRight 0.3s ease-out, fadeOut 0.3s ease-in 4.7s;
            display: flex;
            gap: 1rem;
            align-items: start;
        }

        .rental-toast.success {
            border-left-color: #10b981;
        }

        .rental-toast.error {
            border-left-color: #ef4444;
        }

        .rental-toast-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 24px;
        }

        .rental-toast.success .rental-toast-icon {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .rental-toast.error .rental-toast-icon {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .rental-toast-content {
            flex: 1;
        }

        .rental-toast-title {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: var(--text-dark);
        }

        .rental-toast-message {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .rental-toast-close {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0.25rem;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .rental-toast-close:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }
    </style>

    <script>
        // Toggle Farmer Notifications Panel
        function toggleFarmerNotifications() {
            const panel = document.getElementById('farmerNotificationsPanel');
            panel.classList.toggle('active');

            if (panel.classList.contains('active')) {
                loadFarmerNotifications();
            }
        }

        // Load Farmer's Rental Notifications
        async function loadFarmerNotifications() {
            const userData = JSON.parse(localStorage.getItem('agrohub_user') || '{}');
            const notificationList = document.getElementById('farmerNotificationList');

            if (!userData.id) {
                notificationList.innerHTML = `
                    <div class="farmer-empty-notifications">
                        <span class="material-icons-outlined">login</span>
                        <p>Please log in to view notifications</p>
                    </div>
                `;
                return;
            }

            try {
                notificationList.innerHTML = '<p style="padding: 1.5rem; text-align: center; color: var(--text-secondary);">Loading...</p>';

                const response = await fetch(`php/get_rental_requests.php?user_type=farmer&user_id=${userData.id}`);
                const data = await response.json();

                if (data.success && data.requests && data.requests.length > 0) {
                    // Update badge count for approved/rejected statuses
                    const newUpdates = data.requests.filter(r => r.booking_status === 'approved' || r.booking_status === 'rejected').length;
                    const badge = document.getElementById('farmerNotificationCount');
                    if (newUpdates > 0) {
                        badge.textContent = newUpdates;
                        badge.style.display = 'flex';
                    } else {
                        badge.style.display = 'none';
                    }


                    notificationList.innerHTML = data.requests.map(request => {
                        const statusIcon = request.booking_status === 'approved' ? '✓' :
                            request.booking_status === 'rejected' ? '✗' : '⏳';
                        const statusText = request.booking_status ? request.booking_status.charAt(0).toUpperCase() + request.booking_status.slice(1) : 'Pending';
                        const statusClass = request.booking_status || 'pending';

                        return `
                            <div class="farmer-notification-item ${statusClass}">
                                <div class="farmer-notification-status ${statusClass}">
                                    ${statusIcon} ${statusText}
                                </div>
                                <div class="farmer-notification-title">
                                    ${request.equipment_name || 'Equipment'}
                                </div>
                                <div class="farmer-notification-details">
                                    <div><strong>Duration:</strong> ${request.start_date} to ${request.end_date}</div>
                                    <div><strong>Total Cost:</strong> ₹${parseFloat(request.total_amount || 0).toLocaleString()}</div>
                                </div>
                                <div class="farmer-notification-time">
                                    <span class="material-icons-outlined" style="font-size: 14px;">schedule</span>
                                    Requested: ${request.created_at ? new Date(request.created_at).toLocaleDateString() : 'Recently'}
                                </div>
                                ${request.booking_status === 'approved' ? `
                                    <div style="margin-top: 1rem; padding: 1rem; background: rgba(16,185,129,0.1); border-radius: 12px; font-size: 0.85rem; color: var(--success);">
                                        <strong>✓ Request Approved!</strong><br>
                                        Great news! The owner has accepted your rental request. You will be contacted shortly with further details.
                                    </div>
                                ` : ''}
                                ${request.booking_status === 'rejected' ? `
                                    <div style="margin-top: 1rem; padding: 1rem; background: rgba(239,68,68,0.1); border-radius: 12px; font-size: 0.85rem; color: var(--danger);">
                                        <strong>✗ Request Rejected</strong><br>
                                        Unfortunately, this rental request was not approved by the owner.
                                    </div>
                                ` : ''}
                                ${request.booking_status === 'pending' ? `
                                    <div style="margin-top: 1rem; padding: 1rem; background: rgba(245,158,11,0.1); border-radius: 12px; font-size: 0.85rem; color: var(--warning);">
                                        <strong>⏳ Awaiting Response</strong><br>
                                        The owner is reviewing your request. You'll be notified once they respond.
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('');
                } else {
                    // No requests
                    const badge = document.getElementById('farmerNotificationCount');
                    badge.style.display = 'none';

                    notificationList.innerHTML = `
                        <div class="farmer-empty-notifications">
                            <span class="material-icons-outlined">receipt_long</span>
                            <p>No rental requests yet</p>
                            <p>Your rental requests and their status will appear here</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading farmer notifications:', error);
                notificationList.innerHTML = `
                    <div class="farmer-empty-notifications">
                        <span class="material-icons-outlined">error</span>
                        <p>Failed to load notifications</p>
                        <p>Please try again later</p>
                    </div>
                `;
            }
        }

        // Show Toast Notification for Rental Updates
        function showRentalToast(type, equipmentName, message) {
            const container = document.getElementById('rentalToastContainer');
            const toastId = 'toast-' + Date.now();

            const toast = document.createElement('div');
            toast.id = toastId;
            toast.className = `rental-toast ${type}`;
            toast.innerHTML = `
                <div class="rental-toast-icon">
                    ${type === 'success' ? '✓' : '✗'}
                </div>
                <div class="rental-toast-content">
                    <div class="rental-toast-title">
                        ${type === 'success' ? '🎉 Rental Approved!' : '❌ Rental Rejected'}
                    </div>
                    <div class="rental-toast-message">
                        <strong>${equipmentName}</strong><br>
                        ${message}
                    </div>
                </div>
                <button class="rental-toast-close" onclick="document.getElementById('${toastId}').remove()">
                    <span class="material-icons-outlined" style="font-size: 20px;">close</span>
                </button>
            `;

            container.appendChild(toast);

            // Auto remove after 5 seconds
            setTimeout(() => {
                const toastElement = document.getElementById(toastId);
                if (toastElement) {
                    toastElement.remove();
                }
            }, 5000);
        }

        // Store last known statuses to detect changes
        let lastKnownStatuses = {};

        // Check for new rental status updates
        window.addEventListener('DOMContentLoaded', () => {
            // Check for rental status updates every 30 seconds
            setInterval(async () => {
                const userData = JSON.parse(localStorage.getItem('agrohub_user') || '{}');
                if (userData.id) {
                    try {
                        const response = await fetch(`php/get_rental_requests.php?user_type=farmer&user_id=${userData.id}`);
                        const data = await response.json();

                        if (data.success && data.requests) {
                            // Check each request for status changes
                            data.requests.forEach(request => {
                                const requestId = request.id;
                                const currentStatus = request.booking_status;

                                // If we have a previous status and it's different from current
                                if (lastKnownStatuses[requestId] && lastKnownStatuses[requestId] !== currentStatus) {
                                    // Status changed! Show toast notification
                                    if (currentStatus === 'approved') {
                                        showRentalToast(
                                            'success',
                                            request.equipment_name || 'Your Equipment',
                                            'The owner has accepted your rental request. You will be contacted shortly!'
                                        );
                                    } else if (currentStatus === 'rejected') {
                                        showRentalToast(
                                            'error',
                                            request.equipment_name || 'Your Equipment',
                                            'Unfortunately, this rental request was not approved.'
                                        );
                                    }
                                }

                                // Update last known status
                                lastKnownStatuses[requestId] = currentStatus;
                            });

                            // Update badge count
                            const newUpdates = data.requests.filter(r => r.booking_status === 'approved' || r.booking_status === 'rejected').length;
                            const badge = document.getElementById('farmerNotificationCount');
                            if (newUpdates > 0) {
                                badge.textContent = newUpdates;
                                badge.style.display = 'flex';
                            } else {
                                badge.style.display = 'none';
                            }
                        }
                    } catch (error) {
                        console.error('Error checking farmer notifications:', error);
                    }
                }
            }, 30000); // Check every 30 seconds

            // Initial load
            const userData = JSON.parse(localStorage.getItem('agrohub_user') || '{}');
            if (userData.id) {
                fetch(`php/get_rental_requests.php?user_type=farmer&user_id=${userData.id}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.success && data.requests) {
                            const newUpdates = data.requests.filter(r => r.booking_status === 'approved' || r.booking_status === 'rejected').length;
                            const badge = document.getElementById('farmerNotificationCount');
                            if (newUpdates > 0) {
                                badge.textContent = newUpdates;
                                badge.style.display = 'flex';
                            }
                        }
                    })
                    .catch(err => console.error('Error loading initial farmer notifications:', err));
            }
        });
    </script>
</body>

</html>